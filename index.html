<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Paper Map Data</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href='https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css' rel='stylesheet'/>
    <script src='https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7.0.0/turf.min.js"></script>
    <script src="https://unpkg.com/pmtiles@3.2.0/dist/pmtiles.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #filters {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 300px;
            height: 400px;
            overflow: auto;
            background-color: white;
        }
    </style>
</head>
<body>
<div id="map"></div>
<div id="filters"></div>
<script>
    // Make relative urls work
    if (!location.href.endsWith('index.html')) {
        location.href += '/index.html';
    }

    (async function () {
        let protocol = new pmtiles.Protocol({metadata: true});
        maplibregl.addProtocol("pmtiles", protocol.tile);

        const publishers = await (await fetch('publishers.json')).json();

        const allPublishers = Object.keys(publishers).sort((a, b) => a.localeCompare(b));
        const visiblePublishers = new Set(allPublishers);

        const map = new maplibregl.Map({
            container: 'map',
            style: 'https://api.protomaps.com/styles/v2/light.json?key=1a8ef0d1df776146',
            center: [0, 57],
            zoom: 6,
            hash: true
        });

        const filteredLayers = ["paper-outline", "paper-fill", "paper-label"];

        map.on("load", async () => {
            // In a real deployment loading the icons shouldn't block rendering
            await Promise.all(Object.values(publishers).map(async p => {
                const img = await map.loadImage(p.icon);
                await map.addImage(p.icon, img.data);
            }));

            map.addSource("paper", {type: 'vector', 'url': 'pmtiles://paper_maps.pmtiles'});

            // Layers

            map.addLayer({
                "id": "paper-outline",
                "type": "line",
                "source": "paper",
                "source-layer": "default",
                "slot": "middle",
                "minzoom": 4,
                "layout": {},
                "paint": {
                    "line-color": ["get", "color"],
                    "line-width": 1.5,
                    "line-opacity": 0.8,
                },
            });
            map.addLayer({
                "id": "paper-fill",
                "type": "fill",
                "source": "paper",
                "source-layer": "default",
                "slot": "middle",
                "minzoom": 5,
                "layout": {},
                "paint": {
                    "fill-color": ["get", "color"],
                    "fill-opacity": ["case", ["boolean", ["feature-state", "hover"], false], 0.3, 0.1],
                },
            });
            map.addLayer({
                "id": "paper-label",
                "type": "symbol",
                "source": "paper",
                "source-layer": "default",
                "slot": "top",
                "layout": {
                    "icon-offset": [0, -0.2],
                    "icon-image": ["get", "icon"],
                    "icon-allow-overlap": ['step', ['zoom'], false, 6, true],
                    "icon-anchor": "bottom",
                    "icon-size": ["interpolate", ["linear"], ["zoom"],
                        5, 0.2,
                        9, 0.5,
                    ],

                    "text-offset": [0, 0.2],
                    "text-field": ["step", ["zoom"], "", 7, ["get", "short_title"], 9, ["get", "title"]],
                    "text-allow-overlap": true,
                    "text-size": 14,
                    "text-anchor": "top",
                    "text-font": ["Noto Sans Regular"],
                },
                "paint": {
                    "text-color": ["get", "color"],
                },
            });

            // Filters

            const filtersEl = document.querySelector("#filters");
            const listEl = document.createElement("ul");
            filtersEl.append(listEl);
            for (const publisher of allPublishers) {
                const pubEl = document.createElement("li");
                listEl.append(pubEl);

                const pubCheckEl = document.createElement("input");
                pubEl.append(pubCheckEl);
                pubCheckEl.type = "checkbox";
                pubCheckEl.name = publisher;
                if (visiblePublishers.has(publisher)) {
                    pubCheckEl.checked = true;
                }

                const pubIconEl = document.createElement("img");
                pubEl.append(pubIconEl);
                pubIconEl.src = publishers[publisher]?.icon;
                pubIconEl.width = 18;

                const pubLabelEl = document.createElement("span");
                pubEl.append(pubLabelEl);
                pubLabelEl.innerText = publisher;
            }

            function updateMapFilters() {
                const filterValues = Array.from(visiblePublishers);
                if (filterValues.length === 0) {
                    filterValues.push('');
                }
                let filter = ["in", "publisher", ...filterValues];

                for (const layer of filteredLayers) {
                    map.setFilter(layer, filter);
                }
            }

            updateMapFilters();

            // Interactivity


            filtersEl.addEventListener("change", evt => {
                if (evt.target.checked) {
                    visiblePublishers.add(evt.target.name);
                } else {
                    visiblePublishers.delete(evt.target.name);
                }
                updateMapFilters();
            });


            let hoveredID = null;
            for (const layerID of ["paper-line", "paper-fill"]) {
                map.on("mousemove", layerID, (e) => {
                    if (e.features.length > 0) {
                        if (hoveredID !== null) {
                            map.setFeatureState(
                                {source: "paper", sourceLayer: "default", id: hoveredID},
                                {hover: false}
                            );
                        }
                        hoveredID = e.features[0].id;
                        map.setFeatureState(
                            {source: "paper", sourceLayer: "default", id: hoveredID},
                            {hover: true}
                        );
                    }
                });
                // When the mouse leaves the state-fill layer, update the feature state of the
                // previously hovered feature.
                map.on("mouseleave", layerID, () => {
                    if (hoveredID !== null) {
                        map.setFeatureState(
                            {source: "paper", sourceLayer: "default", id: hoveredID},
                            {hover: false}
                        );
                    }
                    hoveredID = null;
                });

                map.on("click", layerID, (e) => {
                    const f = e.features[0];
                    if (!f) return;
                    const p = f.properties;

                    console.log(f);

                    const coordinates = turf.centroid(f.geometry).geometry.coordinates;

                    // Ensure that if the map is zoomed out such that multiple
                    // copies of the feature are visible, the popup appears
                    // over the copy being pointed to. (only applies to mapbox-gl)
                    if ('getProjection' in map) {
                        if (['mercator', 'equirectangular'].includes(map.getProjection().name)) {
                            while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                            }
                        }
                    }

                    const parentEl = document.createElement("div");
                    parentEl.style.width = "600px";
                    parentEl.style.maxHeight = "600px";
                    parentEl.style.overflow = "auto";

                    const preEl = document.createElement("pre");
                    parentEl.append(preEl);
                    preEl.style.width = "100%";
                    preEl.innerText = JSON.stringify(f.properties, null, 2);

                    if (p.thumbnail) {
                        const thumbEl = document.createElement("img");
                        parentEl.append(thumbEl);
                        thumbEl.src = p.thumbnail;
                    }

                    const purchaseContainer = document.createElement("div");
                    parentEl.append(purchaseContainer);
                    const purchaseLinkEl = document.createElement("a");
                    purchaseContainer.append(purchaseLinkEl);
                    purchaseLinkEl.href = p.purchase_url;
                    purchaseLinkEl.innerText = "Purchase " + p.title;

                    if (p.images) {
                        const imgContainer = document.createElement("ul");
                        parentEl.append(imgContainer);
                        for (const src of JSON.parse(p.images)) {
                            const parentEl = document.createElement("li");
                            imgContainer.append(parentEl);

                            const el = document.createElement("img");
                            parentEl.append(el);
                            el.src = src;
                        }
                    }

                    new maplibregl.Popup()
                        .setMaxWidth(600)
                        .setLngLat(coordinates)
                        .setDOMContent(parentEl)
                        .addTo(map);
                });
            }
        });
    }())
</script>

</body>
</html>
